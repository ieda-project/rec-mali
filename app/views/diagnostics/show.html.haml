= partial 'children/profile'

%h2.em.show
  %strong
    = l(@diagnostic.done_on.getlocal, :format => :diagnostic)
    (#{t(:from, :scope => :datetime)}
    #{time_ago_in_words(@diagnostic.done_on)})
  %span.by Evaluation réalisée par #{@diagnostic.author.name}

- if Csps.point? or @diagnostic.classifications.any?
  %nav
    - if Csps.point?
      = link_to 'Modifier', edit_child_diagnostic_path(@child, @diagnostic), :class => 'edit em'
    - if @diagnostic.classifications.any?
      = link_to 'Traitements', treatments_child_diagnostic_path(@child, @diagnostic), :class => 'validation'

%section.resume
  .measurements
    %h2 Mesures lors de la consultation
    = partial 'children/measurements', locals: { diagnostic: @diagnostic }
    = partial 'diagnostics/indices', locals: { diagnostic: @diagnostic }
  - if @diagnostic.failed_classifications.try :any?
    %section.warning
      %h3 Les classifications suivante on échoués:
      %ul
        - for c in Classification.find(@diagnostic.failed_classifications) do
          %li= c.name

  - for i in Illness.order(:sequence) do
    - answers = @diagnostic.sign_answers.for(i).sort.select {|a| a.applicable?}
    - if answers.any?
      %section.consultation
        %h2.consultation= i.name
        %table
          - for sa in answers do
            %tr
              %th(scope="row")!= sa.sign.question
              %td!= sa.html_value rescue sa.value
        - cs = @diagnostic.classifications.for(i)
        %ul.classification
          - for c in cs do
            %li= c.name

- if @diagnostic.classifications.any?
  %nav
    = link_to 'Modifier', edit_child_diagnostic_path(@child, @diagnostic), :class => 'edit em'
    = link_to 'Traitements', treatments_child_diagnostic_path(@child, @diagnostic), :class => 'validation'
